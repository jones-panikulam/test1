on:
  push:
    branches: [ main ]
 # pull_request:
 #   branches: [ main ]


jobs:

  container-job:
   
    name: run a container
    runs-on: ubuntu-latest
    container: docker:19.03
    services:
      # Label used to access the service container
      docker:
        # Docker Hub image
        image: docker:19.03-dind
    steps:
    - name: Add ssh agent
      run: |
           'which ssh-agent || ( apk update && apk add --no-cache openssh && apk add openssh-client git)'
           mkdir -p ~/.ssh
           echo "$NPCI_DEV_SERVER_KEY" | tr -d '\r' > ~/.ssh/id_rsa
           chmod 700 ~/.ssh/id_rsa
           eval "$(ssh-agent -s)"
           ssh-add ~/.ssh/id_rsa
           ssh-keyscan -H 'gitlab.com' >> ~/.ssh/known_hosts
           apk update && apk add --no-cache python3 py-pip
           
  build: 
  
    name: Build for Dev server in AWS
    runs-on: ubuntu-latest
    needs: [container-job]
    steps:
      - name: Test for environment vairable
        run: echo "build ${{secrets.NAME_VAR}} completed"
             echo "build 3 completed"
            
    if: contains( github.ref, 'main')
    
  build-and-deploy:
  
    name: Deploy for Dev server in AWS
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - run: echo "build 2 completed"
    if: contains( github.ref, 'main') 
